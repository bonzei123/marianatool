{% extends "layout.html" %}

{% block content %}
<div class="row">
    <div class="col-md-10 mx-auto">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2 class="m-0 text-white" style="text-shadow: 1px 1px 4px rgba(0,0,0,0.5);">ðŸ‘¥ User Verwaltung</h2>
            <div class="d-flex gap-2">
                <input type="text" id="userSearch" class="form-control" placeholder="ðŸ” Suche..." onkeyup="filterUsers()">
                <button class="btn btn-success fw-bold shadow" data-bs-toggle="modal" data-bs-target="#createModal">+ User anlegen</button>
            </div>
        </div>

        <div class="card border-0 shadow-lg rounded-3 overflow-hidden">
            <table class="table table-hover mb-0 align-middle" id="userTable">
                <thead class="bg-light">
                    <tr><th class="ps-4">User</th><th>Rolle</th><th>Rechte</th><th class="text-end pe-4">Aktion</th></tr>
                </thead>
                <tbody>
                    {% for user in users %}
                    <tr style="cursor:pointer;"
                        data-id="{{ user.id }}"
                        data-username="{{ user.username }}"
                        data-admin="{{ 'true' if user.is_admin else 'false' }}"
                        data-services="{{ user.services|map(attribute='id')|list|join(',') }}"
                        onclick="openEditModal(this)">
                        <td class="ps-4 fw-bold text-dark">{{ user.username }}</td>
                        <td>
                            {% if user.is_admin %}
                                <span class="badge bg-danger">Admin</span>
                            {% else %}
                                <span class="badge bg-secondary">User</span>
                            {% endif %}
                        </td>
                        <td><small class="text-muted">{{ user.services|length }} Dienste</small></td>
                        <td class="text-end pe-4"><i class="bi bi-pencil-square text-primary fs-5"></i></td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<div class="modal fade" id="createModal" tabindex="-1">
    <div class="modal-dialog">
        <form class="modal-content" action="{{ url_for('create_user') }}" method="POST">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title fw-bold">Neuen User anlegen</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-4">
                <div class="mb-3"><label class="fw-bold">Name</label><input type="text" name="username" class="form-control" required></div>
                <div class="mb-3"><label class="fw-bold">Passwort</label><input type="text" name="password" class="form-control" required></div>
                <div class="form-check form-switch mb-3 p-3 border rounded bg-light">
                    <input class="form-check-input ms-0 me-3" type="checkbox" name="is_admin" style="float:none;">
                    <label class="form-check-label fw-bold">Admin?</label>
                </div>

                <label class="fw-bold mb-2">Apps:</label>
                <div class="d-flex flex-wrap gap-2">
                    {% for service in all_services %}
                    <div class="border rounded px-3 py-2 bg-white flex-fill d-flex align-items-center">
                        <div class="form-check m-0">
                            <input class="form-check-input" type="checkbox" name="services" value="{{ service.id }}" id="new_srv_{{ service.id }}" checked>
                            <label class="form-check-label small fw-bold" for="new_srv_{{ service.id }}">{{ service.name }}</label>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
            <div class="modal-footer"><button class="btn btn-success fw-bold w-100">Anlegen</button></div>
        </form>
    </div>
</div>

<div class="modal fade" id="editModal" tabindex="-1">
    <div class="modal-dialog">
        <form class="modal-content" id="editForm" method="POST">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title fw-bold" id="editTitle">Bearbeiten</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-4">
                <div class="mb-3"><label class="fw-bold">User</label><input type="text" id="editUser" class="form-control" disabled></div>
                <div class="mb-3"><label class="fw-bold">Neues Passwort</label><input type="text" name="password" class="form-control" placeholder="(optional)"></div>
                <div class="form-check form-switch mb-3 p-3 border rounded bg-light">
                    <input class="form-check-input ms-0 me-3" type="checkbox" name="is_admin" id="editAdmin" style="float:none;">
                    <label class="form-check-label fw-bold">Admin?</label>
                </div>

                <label class="fw-bold mb-2">Apps:</label>
                <div class="d-flex flex-wrap gap-2">
                    {% for service in all_services %}
                    <div class="border rounded px-3 py-2 bg-white flex-fill d-flex align-items-center">
                        <div class="form-check m-0">
                            <input class="form-check-input edit-srv" type="checkbox" name="services" value="{{ service.id }}" id="edit_srv_{{ service.id }}">
                            <label class="form-check-label small fw-bold" for="edit_srv_{{ service.id }}">{{ service.name }}</label>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
            <div class="modal-footer justify-content-between">
                <a href="#" id="delBtn" class="btn btn-outline-danger">LÃ¶schen</a>
                <button class="btn btn-primary fw-bold">Speichern</button>
            </div>
        </form>
    </div>
</div>

<script>
    // Wir warten, bis der DOM geladen ist, bevor wir Modal-Instanzen erstellen
    document.addEventListener('DOMContentLoaded', function() {
        // Hilfsfunktion zum Ã–ffnen des Modals
        window.openEditModal = function(row) {
            // Daten aus den data-Attributen holen
            var id = row.getAttribute('data-id');
            var name = row.getAttribute('data-username');
            var isAdmin = row.getAttribute('data-admin') === 'true';
            var servicesRaw = row.getAttribute('data-services');
            var services = servicesRaw ? servicesRaw.split(',').map(Number) : [];

            // Formular Action URL setzen
            document.getElementById('editForm').action = "/admin/users/update/" + id;

            // Felder befÃ¼llen
            document.getElementById('editTitle').innerText = "User: " + name;
            document.getElementById('editUser').value = name;
            document.getElementById('editAdmin').checked = isAdmin;

            // LÃ¶sch-Button Link setzen
            var delBtn = document.getElementById('delBtn');
            delBtn.href = "/admin/users/delete/" + id;
            delBtn.onclick = function() { return confirm("User '" + name + "' wirklich lÃ¶schen?"); };

            // Checkboxen resetten und setzen
            document.querySelectorAll('.edit-srv').forEach(cb => {
                cb.checked = services.includes(parseInt(cb.value));
            });

            // Modal sicher Ã¶ffnen (getOrCreateInstance verhindert Fehler bei mehrfachem Aufruf)
            var myModal = new bootstrap.Modal(document.getElementById('editModal'));
            myModal.show();
        };

        // Suchfunktion
        window.filterUsers = function() {
            var filter = document.getElementById('userSearch').value.toLowerCase();
            var rows = document.querySelectorAll('#userTable tbody tr');
            rows.forEach(r => {
                var text = r.innerText.toLowerCase();
                r.style.display = text.includes(filter) ? '' : 'none';
            });
        };
    });
</script>
{% endblock %}