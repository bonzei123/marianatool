{% extends "layout.html" %}

{% block content %}
<div class="container py-4">

    <div class="d-flex justify-content-between align-items-center mb-4 border-bottom pb-2">
        <h2 class="text-black fw-bold mb-0">⚙️ Einstellungen</h2>
        <p class="text-muted mb-0">Systemkonfiguration</p>
    </div>

    <div class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-4">

        <div class="col">
            <div class="card shadow-sm h-100">
                <div class="card-header bg-dark text-white fw-bold text-center">
                    <i class="bi bi-envelope-at me-2"></i> E-Mail
                </div>
                <div class="card-body d-flex flex-column justify-content-center text-center">
                    <p class="small text-muted mb-3">Empfänger für Berichte & System-Mails.</p>
                    <button class="btn btn-outline-dark fw-bold w-100 mt-auto" data-bs-toggle="modal" data-bs-target="#emailModal">
                        Konfigurieren
                    </button>
                </div>
            </div>
        </div>

        <div class="col">
            <div class="card shadow-sm h-100">
                <div class="card-header bg-primary text-white fw-bold text-center">
                    <i class="bi bi-grid-3x3-gap me-2"></i> Dashboard
                </div>
                <div class="card-body d-flex flex-column justify-content-center text-center">
                    <p class="small text-muted mb-3">Kacheln, Farben & Sortierung der Startseite.</p>
                    <button class="btn btn-outline-primary fw-bold w-100 mt-auto" data-bs-toggle="modal" data-bs-target="#tilesModal">
                        Kacheln bearbeiten
                    </button>
                </div>
            </div>
        </div>

        <div class="col">
            <div class="card shadow-sm h-100">
                <div class="card-header bg-success text-white fw-bold text-center">
                    <i class="bi bi-images me-2"></i> Design
                </div>
                <div class="card-body d-flex flex-column justify-content-center text-center">
                    <p class="small text-muted mb-3">Hintergrundbilder global oder je Recht.</p>
                    <button class="btn btn-outline-success fw-bold w-100 mt-auto" data-bs-toggle="modal" data-bs-target="#bgModal">
                        Bilder verwalten
                    </button>
                </div>
            </div>
        </div>

        <div class="col">
            <div class="card shadow-sm h-100">
                <div class="card-header bg-info text-dark fw-bold text-center">
                    <i class="bi bi-shield-lock me-2"></i> Rechte
                </div>
                <div class="card-body d-flex flex-column justify-content-center text-center">
                    <p class="small text-muted mb-3">Bezeichnungen der Rollen anpassen.</p>
                    <button class="btn btn-outline-info text-dark fw-bold w-100 mt-auto" data-bs-toggle="modal" data-bs-target="#permsModal">
                        Texte anpassen
                    </button>
                </div>
            </div>
        </div>

        <div class="col">
            <div class="card shadow-sm h-100">
                <div class="card-header bg-secondary text-white fw-bold text-center">
                    <i class="bi bi-file-text me-2"></i> Anforderungen
                </div>
                <div class="card-body d-flex flex-column justify-content-center text-center">
                    <p class="small text-muted mb-3">Inhalte des Info-Popups bearbeiten.</p>
                    <button class="btn btn-outline-secondary text-dark fw-bold w-100 mt-auto" data-bs-toggle="modal" data-bs-target="#reqModal">
                        Text bearbeiten
                    </button>
                </div>
            </div>
        </div>

        <div class="col">
            <div class="card shadow-sm h-100">
                <div class="card-header text-white fw-bold text-center" style="background-color: #6610f2;">
                    <i class="bi bi-signpost-2 me-2"></i> Onboarding
                </div>
                <div class="card-body d-flex flex-column justify-content-center text-center">
                    <p class="small text-muted mb-3">Prozess-Builder für neue Projekte.</p>
                    <button class="btn btn-outline-dark fw-bold w-100 mt-auto" onclick="window.location.href='{{ url_for('formbuilder.onboarding_builder_view') }}'">
                        Builder öffnen
                    </button>
                </div>
            </div>
        </div>

        <div class="col">
            <div class="card shadow-sm h-100">
                <div class="card-header bg-dark text-white fw-bold text-center">
                    <i class="bi bi-megaphone me-2"></i> Updates
                </div>
                <div class="card-body d-flex flex-column justify-content-center text-center">
                    <p class="small text-muted mb-3">Patchnotes und Versionierung.</p>
                    <button class="btn btn-outline-dark fw-bold w-100 mt-auto" onclick="openChangelogModal()">
                        Changelog
                    </button>
                </div>
            </div>
        </div>

        <div class="col">
            <div class="card shadow-sm h-100 border-warning">
                <div class="card-header bg-warning text-dark fw-bold text-center">
                    <i class="bi bi-database-down me-2"></i> Import
                </div>
                <div class="card-body d-flex flex-column justify-content-center text-center">
                    <p class="small text-muted mb-3 text-danger fw-bold">Reset: Fragenkatalog neu einlesen.</p>
                    <form action="{{ url_for('admin.import_questions_route') }}" method="POST" class="mt-auto w-100"
                          onsubmit="return confirm('Wirklich neu einlesen? Änderungen gehen verloren.');">
                        <button class="btn btn-warning fw-bold w-100">
                            Import starten
                        </button>
                    </form>
                </div>
            </div>
        </div>

    </div>
</div>

<div class="modal fade" id="emailModal" tabindex="-1">
    <div class="modal-dialog">
        <form class="modal-content" method="POST">
            <div class="modal-header bg-dark text-white">
                <h5 class="modal-title"><i class="bi bi-envelope-at me-2"></i> E-Mail Konfiguration</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label class="form-label fw-bold">Empfänger E-Mail Adresse</label>
                    <input type="email" name="email_receiver" class="form-control" value="{{ email }}" placeholder="name@firma.de" required>
                    <div class="form-text">An diese Adresse werden PDF-Protokolle und wichtige Systemnachrichten gesendet.</div>
                </div>
            </div>
            <div class="modal-footer bg-light">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Abbrechen</button>
                <button type="submit" class="btn btn-dark fw-bold">Speichern</button>
            </div>
        </form>
    </div>
</div>

<div class="modal fade" id="bgModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <form class="modal-content" action="{{ url_for('admin.save_backgrounds') }}" method="POST" enctype="multipart/form-data">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title"><i class="bi bi-images me-2"></i> Design Einstellungen</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-4">
                <h6 class="fw-bold border-bottom pb-2 mb-3">Neues Bild hochladen</h6>
                <div class="mb-4">
                    <label class="form-label small text-muted">Datei auswählen (JPG, PNG, WEBP)</label>
                    <div class="input-group">
                        <input type="file" name="background_image" class="form-control">
                        <button class="btn btn-outline-secondary" type="button" disabled>Upload bei Speichern</button>
                    </div>
                    <div class="form-text">Bilder landen in <code>static/img/backgrounds</code> und stehen unten zur Auswahl.</div>
                </div>

                <h6 class="fw-bold border-bottom pb-2 mb-3">Hintergrund je Berechtigung</h6>
                <div class="alert alert-light border small">
                    <i class="bi bi-info-circle me-1"></i>
                    User sehen das Bild der Berechtigung, die sie haben. Hat ein User mehrere Rechte, gewinnt das "höhere" (technisch: Sortierung nach ID).
                </div>

                <div class="table-responsive">
                    <table class="table table-sm align-middle table-hover">
                        <thead class="table-light">
                        <tr>
                            <th>Berechtigung</th>
                            <th>Zugewiesenes Bild</th>
                        </tr>
                        </thead>
                        <tbody>
                        {% for p in permissions %}
                            <tr>
                                <td>
                                    <i class="bi {{ p.icon }}"></i> <strong>{{ p.name }}</strong>
                                    <div class="small text-muted" style="font-size: 0.75rem;">{{ p.slug }}</div>
                                </td>
                                <td>
                                    <select name="permission_{{ p.id }}_bg" class="form-select form-select-sm">
                                        <option value="">-- Standard (Kein spezielles Bild) --</option>
                                        {% for f in background_files %}
                                            <option value="{{ f }}" {% if p.background_image == f %}selected{% endif %}>
                                                {{ f }}
                                            </option>
                                        {% endfor %}
                                    </select>
                                </td>
                            </tr>
                        {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="modal-footer bg-light">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Abbrechen</button>
                <button type="submit" class="btn btn-success fw-bold">Design speichern</button>
            </div>
        </form>
    </div>
</div>

<div class="modal fade" id="tilesModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <form class="modal-content" action="{{ url_for('admin.save_tiles') }}" method="POST">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title"><i class="bi bi-grid-3x3-gap me-2"></i> Dashboard Kacheln konfigurieren</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-0">
                <div class="table-responsive">
                    <table class="table table-striped table-hover mb-0 align-middle">
                        <thead class="bg-light sticky-top">
                        <tr>
                            <th style="width: 80px;">Pos.</th>
                            <th>Titel</th>
                            <th>Beschreibung</th>
                            <th>Route (Code)</th>
                            <th>Icon</th>
                            <th>Farbe</th>
                            <th>Recht</th>
                        </tr>
                        </thead>
                        <tbody>
                        {% for tile in tiles %}
                            {% set prefix = 'tile_' ~ tile.id ~ '_' %}
                            <tr>
                                <td><input type="number" name="{{ prefix }}order" value="{{ tile.order }}" class="form-control form-control-sm text-center"></td>
                                <td><input type="text" name="{{ prefix }}title" value="{{ tile.title }}" class="form-control form-control-sm fw-bold"></td>
                                <td>
                                    <input type="text" name="{{ prefix }}description" value="{{ tile.description or '' }}" class="form-control form-control-sm" placeholder="Kurzbeschreibung...">
                                </td>
                                <td><input type="text" name="{{ prefix }}route" value="{{ tile.route_name }}" class="form-control form-control-sm text-muted font-monospace"></td>
                                <td>
                                    <div class="input-group input-group-sm">
                                        <span class="input-group-text"><i class="bi {{ tile.icon }}"></i></span>
                                        <input type="text" name="{{ prefix }}icon" value="{{ tile.icon }}" class="form-control">
                                    </div>
                                </td>
                                <td><input type="color" name="{{ prefix }}color" value="{{ tile.color_hex }}" class="form-control form-control-sm form-control-color w-100"></td>
                                <td>
                                    <select name="{{ prefix }}perm" class="form-select form-select-sm">
                                        <option value="None" class="text-success">-- Öffentlich --</option>
                                        {% for p in permissions %}
                                            <option value="{{ p.id }}" {% if tile.required_permission_id == p.id %}selected{% endif %}>{{ p.name }}</option>
                                        {% endfor %}
                                    </select>
                                </td>
                            </tr>
                        {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="modal-footer bg-light">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Abbrechen</button>
                <button type="submit" class="btn btn-primary fw-bold">Kacheln speichern</button>
            </div>
        </form>
    </div>
</div>

<div class="modal fade" id="permsModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <form class="modal-content" action="{{ url_for('admin.save_permissions') }}" method="POST">
            <div class="modal-header bg-info text-dark">
                <h5 class="modal-title"><i class="bi bi-shield-lock me-2"></i> Rechte Texte anpassen</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-0">
                <div class="table-responsive">
                    <table class="table table-striped table-hover mb-0 align-middle">
                        <thead class="bg-light sticky-top">
                        <tr>
                            <th style="width: 50px;">ID</th>
                            <th>Slug (Fix)</th>
                            <th>Anzeigename</th>
                            <th>Beschreibung</th>
                            <th>Icon</th>
                        </tr>
                        </thead>
                        <tbody>
                        {% for p in permissions %}
                            {% set prefix = 'perm_' ~ p.id ~ '_' %}
                            <tr>
                                <td class="text-center text-muted">{{ p.id }}</td>
                                <td><input type="text" value="{{ p.slug }}" class="form-control form-control-sm font-monospace" disabled readonly style="background-color: #eee;"></td>
                                <td><input type="text" name="{{ prefix }}name" value="{{ p.name }}" class="form-control form-control-sm fw-bold"></td>
                                <td><input type="text" name="{{ prefix }}description" value="{{ p.description }}" class="form-control form-control-sm"></td>
                                <td>
                                    <div class="input-group input-group-sm">
                                        <span class="input-group-text"><i class="bi {{ p.icon }}"></i></span>
                                        <input type="text" name="{{ prefix }}icon" value="{{ p.icon }}" class="form-control">
                                    </div>
                                </td>
                            </tr>
                        {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="modal-footer bg-light">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Abbrechen</button>
                <button type="submit" class="btn btn-info fw-bold">Texte speichern</button>
            </div>
        </form>
    </div>
</div>

<div class="modal fade" id="reqModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <form class="modal-content" action="{{ url_for('admin.save_requirements') }}" method="POST">
            <div class="modal-header bg-secondary text-white">
                <h5 class="modal-title"><i class="bi bi-file-text me-2"></i> Anforderungen bearbeiten</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label class="form-label fw-bold">Inhalt (Markdown unterstützt)</label>
                    <textarea name="content" class="form-control font-monospace" rows="15" placeholder="# Bauvorschriften&#10;- Punkt 1... ">{{ requirements_meta.content if requirements_meta else '' }}</textarea>
                </div>
            </div>
            <div class="modal-footer bg-light">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Abbrechen</button>
                <button type="submit" class="btn btn-dark fw-bold">Speichern</button>
            </div>
        </form>
    </div>
</div>

<div class="modal fade" id="changelogModal" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-dark text-white">
                <h5 class="modal-title"><i class="bi bi-megaphone me-2"></i> Version & Patchnotes bearbeiten</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-4">
                <div class="mb-3">
                    <label class="form-label fw-bold">Aktuelle Version</label>
                    <input type="text" id="settingVersion" class="form-control" placeholder="z.B. 1.2.0">
                </div>
                <div class="mb-3">
                    <label class="form-label fw-bold">Inhalt (Markdown unterstützt)</label>
                    <textarea id="settingChangelogText" class="form-control font-monospace" rows="10" placeholder="# Update 1.2.0&#10;- Feature A hinzugefügt&#10;- Bug B gefixt..."></textarea>
                    <div class="form-text">Verwende Markdown für Formatierung (# Überschrift, - Liste, **Fett**)</div>
                </div>
            </div>
            <div class="modal-footer bg-light">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Abbrechen</button>
                <button type="button" class="btn btn-dark fw-bold" onclick="saveChangelogSettings()">Speichern & Veröffentlichen</button>
            </div>
        </div>
    </div>
</div>

<script>
    // Laden beim Öffnen
    async function openChangelogModal() {
        try {
            const res = await fetch('/settings/changelog');
            const data = await res.json();
            document.getElementById('settingVersion').value = data.version;
            document.getElementById('settingChangelogText').value = data.text;
            new bootstrap.Modal(document.getElementById('changelogModal')).show();
        } catch(e) { alert("Fehler beim Laden"); }
    }

    // Speichern
    async function saveChangelogSettings() {
        const version = document.getElementById('settingVersion').value;
        const text = document.getElementById('settingChangelogText').value;

        try {
            const res = await fetch('/settings/changelog', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ version: version, text: text })
            });
            const data = await res.json();
            if(data.success) {
                location.reload(); // Reload damit Footer sich aktualisiert
            } else {
                alert("Fehler: " + data.error);
            }
        } catch(e) { alert("Speicherfehler"); }
    }
</script>
{% endblock %}