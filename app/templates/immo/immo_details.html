{% extends "layout.html" %}

{% block content %}
    <style>
        /* Styles vom Formular-Generator (unverÃ¤ndert) */
        .field-wrapper { display: inline-block; vertical-align: top; padding: 10px; box-sizing: border-box; }
        .w-half { width: 50%; }
        .w-full { width: 100%; }
        .field-wrapper label { display: block; font-weight: bold; margin-bottom: 5px; font-size: 0.9rem; color:#555; }
        .field-wrapper input, .field-wrapper select, .field-wrapper textarea {
            width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px;
        }
        @media(max-width: 768px) { .w-half { width: 100%; } }

        /* Dashed Border fÃ¼r Upload Card */
        .border-dashed { border-style: dashed !important; }
        .hover-lift:hover { transform: translateY(-3px); transition: transform 0.2s; }
        .cursor-pointer { cursor: pointer; }
    </style>

    <div class="container-fluid py-4">
        <div class="d-flex justify-content-between align-items-center mb-4 border-bottom pb-3">
            <div>
                <h2 class="mb-0 fw-bold">{{ inspection.csc_name }}</h2>
                <div class="text-muted small mt-1">
                    <i class="bi bi-hash"></i> {{ inspection.id }} &bull;
                    <i class="bi bi-calendar"></i> {{ inspection.created_at.strftime('%d.%m.%Y') }}
                </div>
            </div>
            <div class="d-flex gap-2 align-items-center">
                <a href="{{ url_for('projects.generate_and_download_pdf', inspection_id=inspection.id) }}" class="btn btn-outline-danger" target="_blank">
                    <i class="bi bi-file-pdf"></i> PDF
                </a>
                <a href="{{ url_for('projects.overview') }}" class="btn btn-outline-secondary">
                    <i class="bi bi-arrow-left"></i> ZurÃ¼ck
                </a>

                {# --- STATUS BUTTONS --- #}
                {% if current_user.is_admin or current_user.has_permission('immo_files_access') %}
                    {# ADMIN / LEITUNG #}
                    <div class="dropdown">
                        <button class="btn btn-{{ inspection.status_color }} dropdown-toggle fw-bold" type="button" data-bs-toggle="dropdown">
                            {{ inspection.status_label }}
                        </button>
                        <ul class="dropdown-menu dropdown-menu-end shadow">
                            <li><h6 class="dropdown-header">Status Ã¤ndern</h6></li>
                            <li><button class="dropdown-item" onclick="confirmStatus('submitted')">ðŸ”µ Eingereicht</button></li>
                            <li><button class="dropdown-item" onclick="confirmStatus('review')">ðŸŸ¡ In PrÃ¼fung</button></li>
                            <li><button class="dropdown-item" onclick="confirmStatus('done')">ðŸŸ¢ Genehmigt</button></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><button class="dropdown-item text-danger" onclick="confirmStatus('rejected')">ðŸ”´ Ablehnen</button></li>
                        </ul>
                    </div>
                {% else %}
                    {# MITARBEITER #}
                    {% if inspection.status == 'draft' and inspection.user_id == current_user.id %}
                        <button class="btn btn-outline-primary fw-bold" onclick="confirmStatus('submitted')">
                            <i class="bi bi-send-fill me-1"></i> Einreichen
                        </button>
                    {% else %}
                        <span class="badge bg-{{ inspection.status_color }} fs-6 px-3 py-2">{{ inspection.status_label }}</span>
                    {% endif %}
                {% endif %}
            </div>
        </div>

        <ul class="nav nav-tabs nav-tabs-bordered mb-4" id="projectTabs" role="tablist">
            <li class="nav-item">
                <button class="nav-link active" id="meta-tab" data-bs-toggle="tab" data-bs-target="#meta"><i class="bi bi-clipboard-data me-2"></i> Informationen</button>
            </li>
            <li class="nav-item">
                <button class="nav-link" id="form-tab" data-bs-toggle="tab" data-bs-target="#form"><i class="bi bi-pencil-square me-2"></i> Formular</button>
            </li>
            <li class="nav-item">
                <button class="nav-link" id="files-tab" data-bs-toggle="tab" data-bs-target="#files"><i class="bi bi-folder2-open me-2"></i> Dateien <span class="badge bg-secondary ms-1">{{ files|length }}</span></button>
            </li>
        </ul>

        <div class="tab-content" id="projectTabsContent">

            <div class="tab-pane fade show active" id="meta" role="tabpanel">
                <div class="row g-4">
                    <div class="col-lg-7">
                        <div class="card shadow-sm h-100">
                            <div class="card-header bg-light fw-bold">Projekt Details</div>
                            <div class="card-body">
                                <div class="row mb-3">
                                    <label class="col-sm-5 text-muted">Projekt Name (CSC)</label>
                                    <div class="col-sm-7 fw-bold">{{ inspection.csc_name }}</div>
                                </div>
                                <div class="row mb-3">
                                    <label class="col-sm-5 text-muted">Erfasst von</label>
                                    <div class="col-sm-7">
                                        <div class="d-flex align-items-center">
                                            <div class="rounded-circle bg-secondary text-white d-flex justify-content-center align-items-center me-2" style="width:24px; height:24px; font-size:0.7rem;">{{ inspection.user.username[0]|upper }}</div>
                                            <div>
                                                {{ inspection.user.username }}
                                                <span class="text-muted small ms-2">({{ 'Admin/Leitung' if inspection.user.is_admin or inspection.user.has_permission('immo_files_access') else 'Mitarbeiter' }})</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="row mb-3">
                                    <label class="col-sm-5 text-muted">Immobilien Typ</label>
                                    <div class="col-sm-7"><span class="badge bg-light text-dark border">{{ inspection.inspection_type }}</span></div>
                                </div>

                                <hr>
                                <h6 class="text-primary mb-3">Wichtige Eckdaten</h6>

                                {% for item in meta_fields %}
                                <div class="row mb-2 border-bottom pb-2">
                                    <label class="col-sm-5 text-muted">{{ item.label }}</label>
                                    <div class="col-sm-7 fw-bold text-dark">{{ item.value if item.value else '-' }}</div>
                                </div>
                                {% else %}
                                <div class="text-muted small fst-italic">Keine Metadaten definiert.</div>
                                {% endfor %}
                            </div>
                        </div>
                    </div>

                    <div class="col-lg-5">
                        <div class="card shadow-sm h-100">
                            <div class="card-header bg-light fw-bold">Historie & Logs</div>
                            <div class="card-body p-0" style="max-height: 400px; overflow-y: auto;">
                                <ul class="list-group list-group-flush">
                                    {% for log in inspection.logs %}
                                        <li class="list-group-item">
                                            <div class="d-flex justify-content-between">
                                                <span class="fw-bold small">{{ log.user.username }}</span>
                                                <span class="text-muted" style="font-size: 0.75em">{{ log.timestamp.strftime('%d.%m.%Y %H:%M') }}</span>
                                            </div>
                                            <div class="small mt-1 text-secondary">{{ log.details }}</div>
                                        </li>
                                    {% else %}
                                        <li class="list-group-item text-muted text-center py-4">Noch keine Ã„nderungen protokolliert.</li>
                                    {% endfor %}
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="tab-pane fade" id="form" role="tabpanel">
                <div class="d-flex align-items-center justify-content-between alert alert-light border mb-4">
                    <div class="d-flex align-items-center">
                        <i class="bi bi-pencil-square fs-4 text-primary me-3"></i>
                        <div><strong>Bearbeitungsmodus</strong><br><small class="text-muted">Ã„nderungen werden im Log gespeichert.</small></div>
                    </div>
                    <button class="btn btn-primary fw-bold" onclick="saveFormData()"><i class="bi bi-save me-2"></i> Speichern</button>
                </div>
                <div id="formContainer" class="pb-5"><div class="text-center py-5"><div class="spinner-border text-primary"></div></div></div>
            </div>

            <div class="tab-pane fade" id="files" role="tabpanel">
                <div class="row g-3">
                    {# --- NEU: UPLOAD KACHEL --- #}
                    <div class="col-6 col-md-4 col-lg-2">
                        <div class="card h-100 shadow-sm border-2 border-dashed bg-white text-center hover-lift"
                             style="cursor: pointer; min-height: 120px;"
                             onclick="triggerNeutralUpload()">
                            <div class="card-body d-flex flex-column align-items-center justify-content-center text-primary">
                                <i class="bi bi-cloud-arrow-up fs-1 mb-2"></i>
                                <div class="fw-bold small">Datei hochladen</div>
                                <div class="text-muted" style="font-size: 0.7rem;">Allgemein</div>
                            </div>
                        </div>
                        <input type="file" id="neutralFileInput" style="display: none;">
                    </div>

                    {# --- DATEIEN LISTE --- #}
                    {% for file in files %}
                        {% set file_url = url_for('projects.download_file', project=file.folder, filename=file.name) %}
                        {# Bestimmen des Typs fÃ¼r JS Helper #}
                        {% set f_type = 'img' if file.is_img else 'vid' if file.is_vid else 'pdf' if file.name.lower().endswith('.pdf') else 'other' %}

                        <div class="col-6 col-md-4 col-lg-2">
                            <div class="card h-100 shadow-sm border-0 bg-light folder-card hover-lift cursor-pointer"
                                 onclick="openFilePreview('{{ file_url }}', '{{ file.name }}', '{{ f_type }}')">

                                <div class="card-body text-center d-flex flex-column align-items-center justify-content-center p-3">
                                    {% if file.is_img %}
                                        <img src="{{ file_url }}" class="mb-2 rounded shadow-sm" style="max-height: 80px; max-width: 100%; object-fit: cover;">
                                    {% elif file.is_vid %}<i class="bi bi-camera-video-fill fs-1 text-secondary mb-2"></i>
                                    {% elif file.name.lower().endswith('.pdf') %}<i class="bi bi-file-earmark-pdf-fill fs-1 text-danger mb-2"></i>
                                    {% else %}<i class="bi bi-file-earmark-fill fs-1 text-secondary mb-2"></i>{% endif %}
                                    <div class="small text-truncate w-100 fw-bold">{{ file.name }}</div>
                                    <div class="text-muted" style="font-size: 0.7rem;">{{ file.size }} MB</div>
                                </div>
                            </div>
                        </div>
                    {% else %}
                        {# Hinweis nur anzeigen, wenn auch keine Upload-Kachel da wÃ¤re (aber die ist ja jetzt da) #}
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="filePreviewModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-xl modal-dialog-centered modal-dialog-scrollable">
            <div class="modal-content" style="height: 90vh;">
                <div class="modal-header">
                    <h5 class="modal-title text-truncate" id="previewTitle" style="max-width: 80%;">Dateivorschau</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body p-0 bg-dark d-flex align-items-center justify-content-center position-relative">
                    <div id="previewContent" class="w-100 h-100 d-flex align-items-center justify-content-center">
                        </div>
                </div>
                <div class="modal-footer bg-light">
                    <a href="#" id="previewDownloadBtn" class="btn btn-primary" download target="_blank">
                        <i class="bi bi-download"></i> Herunterladen / Ã–ffnen
                    </a>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">SchlieÃŸen</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const savedResponses = {{ inspection.data_json | safe }} || {};
        const inspectionId = {{ inspection.id }};
        const formConfigUrl = "{{ url_for('projects.get_project_config', inspection_id=inspection.id) }}";
        const uploadFolder = "{{ folder_name }}";


        // --- Status Ã¤ndern Wrapper ---
        function confirmStatus(newStatus) {
            if (!confirm("MÃ¶chtest du den Status wirklich auf '" + newStatus + "' Ã¤ndern?")) return;
            if(typeof setStatus === 'function') setStatus(newStatus);
        }

        // --- Neutraler Upload Trigger ---
        function triggerNeutralUpload() {
            const input = document.getElementById('neutralFileInput');
            input.value = null; // Reset
            input.click();
        }

        document.getElementById('neutralFileInput').addEventListener('change', function(e) {
            if(this.files && this.files[0]) {
                if(typeof uploadFileGeneric === 'function') {
                    uploadFileGeneric(this.files[0]);
                } else {
                    alert("Upload-Funktion noch nicht geladen.");
                }
            }
        });

    </script>
    <script src="{{ url_for('static', filename='js/immo_details.js') }}"></script>
{% endblock %}