{% extends "layout.html" %}

{% block content %}
    <style>
    /* Styles vom Formular-Generator */
    .field-wrapper { display: inline-block; vertical-align: top; padding: 10px; box-sizing: border-box; }
    .w-half { width: 50%; }
    .w-full { width: 100%; }
    .field-wrapper label { display: block; font-weight: bold; margin-bottom: 5px; font-size: 0.9rem; color:#555; }
    .field-wrapper input[type="text"],
    .field-wrapper input[type="number"],
    .field-wrapper input[type="date"],
    .field-wrapper select,
    .field-wrapper textarea {
        width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px;
    }

    /* Responsive Fix fÃ¼r Mobile */
    @media(max-width: 768px) {
        .w-half { width: 100%; }
    }
</style>
<div class="container-fluid py-4">
    <div class="d-flex justify-content-between align-items-center mb-4 border-bottom pb-3">
        <div>
            <h2 class="mb-0 fw-bold">{{ inspection.csc_name }}</h2>
            <div class="text-muted small mt-1">
                <i class="bi bi-hash"></i> {{ inspection.id }} &bull;
                <i class="bi bi-calendar"></i> {{ inspection.created_at.strftime('%d.%m.%Y') }}
            </div>
        </div>
        <div class="d-flex gap-2 align-items-center">
            <a href="{{ url_for('projects.overview') }}" class="btn btn-outline-secondary">
                <i class="bi bi-arrow-left"></i> ZurÃ¼ck
            </a>

            {% if current_user.is_admin or current_user.has_permission('immo_files_access') %}
            <div class="dropdown">
                <button class="btn btn-{{ inspection.status_color }} dropdown-toggle fw-bold"
                        type="button"
                        data-bs-toggle="dropdown">
                    {{ inspection.status_label }}
                </button>
                <ul class="dropdown-menu dropdown-menu-end shadow">
                    <li><h6 class="dropdown-header">Status Ã¤ndern</h6></li>
                    <li><button class="dropdown-item" onclick="setStatus('submitted')">ðŸ”µ Eingereicht</button></li>
                    <li><button class="dropdown-item" onclick="setStatus('review')">ðŸŸ¡ In PrÃ¼fung</button></li>
                    <li><button class="dropdown-item" onclick="setStatus('done')">ðŸŸ¢ Genehmigt</button></li>
                    <li><hr class="dropdown-divider"></li>
                    <li><button class="dropdown-item text-danger" onclick="setStatus('rejected')">ðŸ”´ Ablehnen</button></li>
                </ul>
            </div>
            {% else %}
                <span class="badge bg-{{ inspection.status_color }} fs-6 px-3 py-2">{{ inspection.status_label }}</span>
            {% endif %}
        </div>
    </div>

    <ul class="nav nav-tabs nav-tabs-bordered mb-4" id="projectTabs" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="meta-tab" data-bs-toggle="tab" data-bs-target="#meta" type="button">
                <i class="bi bi-clipboard-data me-2"></i> Metadaten
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="form-tab" data-bs-toggle="tab" data-bs-target="#form" type="button">
                <i class="bi bi-pencil-square me-2"></i> Formular
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="files-tab" data-bs-toggle="tab" data-bs-target="#files" type="button">
                <i class="bi bi-folder2-open me-2"></i> Dateien <span class="badge bg-secondary ms-1">{{ files|length }}</span>
            </button>
        </li>
    </ul>

    <div class="tab-content" id="projectTabsContent">

        <div class="tab-pane fade show active" id="meta" role="tabpanel">
            <div class="row g-4">
                <div class="col-lg-7">
                    <div class="card shadow-sm h-100">
                        <div class="card-header bg-light fw-bold">Projekt Details</div>
                        <div class="card-body">
                            <div class="row mb-3">
                                <label class="col-sm-4 text-muted">Projekt Name (CSC)</label>
                                <div class="col-sm-8 fw-bold">{{ inspection.csc_name }}</div>
                            </div>
                            <div class="row mb-3">
                                <label class="col-sm-4 text-muted">Erfasst von</label>
                                <div class="col-sm-8">
                                    <div class="d-flex align-items-center">
                                        <div class="rounded-circle bg-secondary text-white d-flex justify-content-center align-items-center me-2" style="width:24px; height:24px; font-size:0.7rem;">
                                            {{ inspection.user.username[0]|upper }}
                                        </div>
                                        {{ inspection.user.username }}
                                    </div>
                                </div>
                            </div>
                            <div class="row mb-3">
                                <label class="col-sm-4 text-muted">Typ</label>
                                <div class="col-sm-8"><span class="badge bg-light text-dark border">{{ inspection.inspection_type }}</span></div>
                            </div>

                            <hr>
                            <h6 class="text-primary mb-3">Daten aus Formular</h6>

                            <div class="row mb-2">
                                <label class="col-sm-4 text-muted">Zusatzinfo 1</label>
                                <div class="col-sm-8">{{ form_responses.get('verein_name', '-') }}</div>
                            </div>
                            <div class="row mb-2">
                                <label class="col-sm-4 text-muted">Zusatzinfo 2</label>
                                <div class="col-sm-8">{{ form_responses.get('strasse', '-') }}</div>
                            </div>
                            </div>
                    </div>
                </div>

                <div class="col-lg-5">
                    <div class="card shadow-sm h-100">
                        <div class="card-header bg-light fw-bold">Historie & Logs</div>
                        <div class="card-body p-0" style="max-height: 400px; overflow-y: auto;">
                            <ul class="list-group list-group-flush">
                                {% for log in inspection.logs %}
                                <li class="list-group-item">
                                    <div class="d-flex justify-content-between">
                                        <span class="fw-bold small">{{ log.user.username }}</span>
                                        <span class="text-muted" style="font-size: 0.75em">{{ log.timestamp.strftime('%d.%m.%Y %H:%M') }}</span>
                                    </div>
                                    <div class="small mt-1 text-secondary">{{ log.details }}</div>
                                </li>
                                {% else %}
                                <li class="list-group-item text-muted text-center py-4">Noch keine Ã„nderungen protokolliert.</li>
                                {% endfor %}
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="tab-pane fade" id="form" role="tabpanel">
            <div class="d-flex align-items-center justify-content-between alert alert-light border mb-4">
                <div class="d-flex align-items-center">
                    <i class="bi bi-pencil-square fs-4 text-primary me-3"></i>
                    <div>
                        <strong>Bearbeitungsmodus</strong><br>
                        <small class="text-muted">Ã„nderungen werden im Log gespeichert.</small>
                    </div>
                </div>
                <button class="btn btn-primary fw-bold" onclick="saveFormData()">
                    <i class="bi bi-save me-2"></i> Speichern
                </button>
            </div>

            <div id="formContainer" class="pb-5">
                <div class="text-center py-5"><div class="spinner-border text-primary"></div></div>
            </div>
        </div>

        <div class="tab-pane fade" id="files" role="tabpanel">
            <div class="row g-3">
                {% for file in files %}
                {% set file_url = url_for('projects.download_file', project=file.folder, filename=file.name) %}
                <div class="col-6 col-md-4 col-lg-2">
                    <div class="card h-100 shadow-sm border-0 bg-light folder-card">
                        <a href="{{ file_url }}" target="_blank" class="card-body text-center d-flex flex-column align-items-center justify-content-center text-decoration-none text-dark p-3">
                            {% if file.is_img %}
                                <img src="{{ file_url }}" class="mb-2 rounded shadow-sm" style="max-height: 80px; max-width: 100%; object-fit: cover;">
                            {% elif file.is_vid %}
                                <i class="bi bi-camera-video-fill fs-1 text-secondary mb-2"></i>
                            {% elif file.name.lower().endswith('.pdf') %}
                                <i class="bi bi-file-earmark-pdf-fill fs-1 text-danger mb-2"></i>
                            {% else %}
                                <i class="bi bi-file-earmark-fill fs-1 text-secondary mb-2"></i>
                            {% endif %}
                            <div class="small text-truncate w-100 fw-bold">{{ file.name }}</div>
                            <div class="text-muted" style="font-size: 0.7rem;">{{ file.size }} MB</div>
                        </a>
                    </div>
                </div>
                {% else %}
                <div class="col-12 text-center text-muted py-5">
                    <i class="bi bi-folder-x fs-1 d-block mb-3 opacity-50"></i>
                    Keine Dateien gefunden.
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
</div>

<script>
    const savedResponses = {{ inspection.data_json | safe }};
    const inspectionId = {{ inspection.id }};
    const formConfigUrl = "{{ url_for('projects.get_form_config') }}";
</script>

<script src="{{ url_for('static', filename='js/immo_details.js') }}"></script>
{% endblock %}