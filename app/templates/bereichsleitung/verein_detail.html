{% extends "layout.html" %}

{% block content %}
    <div class="container-fluid">

        <div class="d-flex justify-content-between align-items-center mb-4">
            <div class="d-flex align-items-center">
                <a href="{{ url_for('bereichsleitung.index') }}#clubs" class="btn btn-outline-secondary me-3">
                    <i class="bi bi-arrow-left"></i> Zurück
                </a>
                <div>
                    <h2 class="text-black fw-bold mb-0">Vereinsverwaltung</h2>
                    <p class="text-black-50 mb-0">Detailansicht & Administration</p>
                </div>
            </div>
            <div>
                <button type="submit" form="detailForm" class="btn btn-primary fw-bold px-4 shadow">
                    <i class="bi bi-save me-2"></i>Änderungen speichern
                </button>
            </div>
        </div>

        <form id="detailForm" method="POST" action="{{ url_for('bereichsleitung.verein_detail', id=verein.id) }}">
            <div class="row">

                <div class="col-lg-8">

                    <div class="card shadow-sm border-0 mb-4">
                        <div class="card-header bg-light fw-bold text-uppercase text-muted small">
                            <i class="bi bi-info-circle me-2"></i>Stammdaten
                        </div>
                        <div class="card-body">
                            <div class="row mb-3">
                                <div class="col-md-12">
                                    <label class="fw-bold form-label">Vereinsname</label>
                                    <input type="text" name="name" class="form-control form-control-lg fw-bold" value="{{ verein.name }}" required>
                                </div>
                            </div>
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <label class="fw-bold form-label">Zusatz / Straße</label>
                                    <input type="text" class="form-control" placeholder="Optional" disabled>
                                </div>
                                <div class="col-md-2">
                                    <label class="fw-bold form-label">PLZ</label>
                                    <input type="text" name="zip_code" class="form-control" value="{{ verein.zip_code or '' }}">
                                </div>
                                <div class="col-md-4">
                                    <label class="fw-bold form-label">Stadt</label>
                                    <input type="text" name="city" class="form-control" value="{{ verein.city or '' }}">
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-6">
                                    <label class="fw-bold form-label">Bundesland (Sitz)</label>
                                    <select name="state_seat" class="form-select">
                                        <option value="">- Wählen -</option>
                                        {% for k, v in states %}
                                            <option value="{{ k }}" {% if verein.state_seat == k %}selected{% endif %}>{{ v }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <div class="col-md-6">
                                    <label class="fw-bold form-label">Bundesland (Abgabe Default)</label>
                                    <select name="state_dist" class="form-select">
                                        <option value="">- Wie Sitz (Default) -</option>
                                        {% for k, v in states %}
                                            <option value="{{ k }}" {% if verein.state_dist == k %}selected{% endif %}>{{ v }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="card shadow-sm border-0 mb-4">
                        <div class="card-header bg-light fw-bold text-uppercase text-muted small">
                            <i class="bi bi-bank me-2"></i>Status & Personal
                        </div>
                        <div class="card-body">
                            <div class="row mb-4">
                                <div class="col-md-6">
                                    <label class="fw-bold form-label text-success">Aktueller Status</label>
                                    <select name="status" class="form-select border-success">
                                        {% for s in status_options %}
                                            <option value="{{ s.id }}" {% if verein.status_id == s.id %}selected{% endif %}>
                                                {{ s.name }}
                                            </option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <div class="col-md-6 d-flex align-items-center pt-4">
                                    <div class="form-check form-switch">
                                        <input class="form-check-input" type="checkbox" name="is_ev" id="evCheck" {% if verein.is_ev %}checked{% endif %}>
                                        <label class="form-check-label fw-bold ms-2" for="evCheck">Als e.V. eingetragen</label>
                                    </div>
                                </div>
                            </div>
                            <hr>
                            <div class="row">
                                <div class="col-md-6">
                                    <label class="fw-bold form-label">Vorstandsvorsitzende(r)</label>
                                    <input type="text" name="board_member" class="form-control" value="{{ verein.board_member or '' }}">
                                </div>
                                <div class="col-md-6">
                                    <label class="fw-bold form-label">Präventionsbeauftragte(r)</label>
                                    <input type="text" name="prev_officer" class="form-control" value="{{ verein.prev_officer or '' }}">
                                </div>
                            </div>
                        </div>
                    </div>

                </div> <div class="col-lg-4">

                <div class="card shadow-sm border-0 mb-4">
                    <div class="card-header bg-success text-white fw-bold d-flex justify-content-between align-items-center">
                        <span><i class="bi bi-flower1 me-2"></i>Anbaustelle</span>
                        {% if verein.anbaustelle_id %}
                            <a href="{{ url_for('bereichsleitung.anbau_detail', id=verein.anbaustelle_id) }}" class="text-white" title="Zu den Details"><i class="bi bi-arrow-up-right-square-fill"></i></a>
                        {% endif %}
                    </div>
                    <div class="card-body">
                        <p class="small text-muted mb-2">Wo wird angebaut? (Cluster / Standort)</p>
                        <select name="anbaustelle_id" class="form-select mb-3">
                            <option value="none">- Keine Zuweisung -</option>
                            {% for a in all_anbaustellen %}
                                <option value="{{ a.id }}" {% if verein.anbaustelle_id == a.id %}selected{% endif %}>
                                    {{ a.name }} ({{ a.anbau_type }})
                                </option>
                            {% endfor %}
                        </select>
                        {% if verein.anbaustelle %}
                            <div class="alert alert-light border small py-2 mb-0">
                                <div class="d-flex justify-content-between align-items-start mb-2">
                                    <div>
                                        <strong>{{ verein.anbaustelle.name }}</strong><br>
                                        <span class="badge bg-secondary">{{ verein.anbaustelle.anbau_type|capitalize }}</span>
                                    </div>
                                    <span class="badge border" style="{{ verein.anbaustelle.status_color_css }}">
                        {{ verein.anbaustelle.status_label }}
                    </span>
                                </div>
                                <hr class="my-1">
                                <i class="bi bi-geo-alt-fill text-success"></i>
                                {{ verein.anbaustelle.address or 'k.A.' }}, {{ verein.anbaustelle.state or 'k.A.' }}
                            </div>
                        {% endif %}
                    </div>
                </div>

                <div class="card shadow-sm border-0 mb-4">
                    <div class="card-header bg-warning text-dark fw-bold d-flex justify-content-between align-items-center">
                        <span><i class="bi bi-shop me-2"></i>Ausgabestelle</span>
                        {% if current_ausgabe %}
                            <a href="{{ url_for('bereichsleitung.ausgabe_detail', id=current_ausgabe.id) }}" class="text-dark" title="Zu den Details"><i class="bi bi-arrow-up-right-square-fill"></i></a>
                        {% endif %}
                    </div>
                    <div class="card-body">
                        <p class="small text-muted mb-2">Wo findet die Abgabe statt?</p>
                        <select name="ausgabestelle_id" class="form-select mb-3">
                            <option value="none">- Keine Zuweisung -</option>
                            {% for aus in all_ausgabestellen %}
                                <option value="{{ aus.id }}"
                                        {% if current_ausgabe and current_ausgabe.id == aus.id %}selected{% endif %}>
                                    {{ aus.address }} ({{ aus.state }})
                                    {% if aus.verein and aus.verein.id != verein.id %}
                                        [Aktuell bei: {{ aus.verein.name }}]
                                    {% endif %}
                                </option>
                            {% endfor %}
                        </select>
                        {% if current_ausgabe %}
                            <div class="alert alert-light border small py-2 mb-0">
                                <div class="d-flex justify-content-between mb-2">
                                    <strong>Standort:</strong>
                                    <span class="badge border" style="{{ current_ausgabe.status_color_css }}">
                        {{ current_ausgabe.status_label }}
                    </span>
                                </div>
                                <i class="bi bi-geo-alt-fill text-warning"></i>
                                {{ current_ausgabe.address }} ({{ current_ausgabe.state }})
                            </div>
                        {% endif %}
                    </div>
                </div>

                <div class="card shadow-sm border-0 mb-4">
                    <div class="card-header bg-dark text-white fw-bold">
                        <i class="bi bi-people-fill me-2"></i>Bereichsleitung
                    </div>
                    <div class="card-body">
                        <p class="small text-muted mb-3">
                            Wer verwaltet diesen Verein?
                        </p>
                        <div class="list-group" style="max-height: 250px; overflow-y: auto;">
                            {% for user in potential_managers %}
                                <label class="list-group-item d-flex gap-3">
                                    <input class="form-check-input flex-shrink-0" type="checkbox" name="manager_ids" value="{{ user.id }}"
                                           {% if user in verein.managers %}checked{% endif %}>
                                    <span class="pt-1 form-checked-content">
                                        <strong>{{ user.username }}</strong>
                                        <small class="d-block text-muted">{{ user.email }}</small>
                                    </span>
                                </label>
                            {% else %}
                                <div class="alert alert-warning small">
                                    Keine User mit 'bl_bl' Berechtigung gefunden.
                                </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>

            </div> </div>
        </form>
    </div>
{% endblock %}